<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="Tim Menzies" />
  <meta name="dcterms.date" content="2024-08-05" />
  <title>A quick peek at exr.py</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    /* CSS for syntax highlighting */
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {  background-color: #f8f8f8; }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ef2929; } /* Alert */
    code span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #204a87; } /* Attribute */
    code span.bn { color: #0000cf; } /* BaseN */
    code span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4e9a06; } /* Char */
    code span.cn { color: #8f5902; } /* Constant */
    code span.co { color: #8f5902; font-style: italic; } /* Comment */
    code span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
    code span.dt { color: #204a87; } /* DataType */
    code span.dv { color: #0000cf; } /* DecVal */
    code span.er { color: #a40000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #0000cf; } /* Float */
    code span.fu { color: #204a87; font-weight: bold; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #204a87; font-weight: bold; } /* Keyword */
    code span.op { color: #ce5c00; font-weight: bold; } /* Operator */
    code span.ot { color: #8f5902; } /* Other */
    code span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
    code span.sc { color: #ce5c00; font-weight: bold; } /* SpecialChar */
    code span.ss { color: #4e9a06; } /* SpecialString */
    code span.st { color: #4e9a06; } /* String */
    code span.va { color: #000000; } /* Variable */
    code span.vs { color: #4e9a06; } /* VerbatimString */
    code span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="ezr.css" />
  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js"
  type="text/javascript"></script>
</head>
<body>
<a href="https://github.com/timm/ezr"> <img
alt="Home" src="https://img.shields.io/badge/home-black"></a> <a href="https://raw.githubusercontent.com/timm/ezr/main/ezr.py"> <img
alt="Download" src="https://img.shields.io/badge/download-gold"></a> <a 
href="https://github.com/timm/ezr/issues"> <img
alt="Issues" src="https://img.shields.io/badge/issues-red"></a> <a 
href="https://github.com/timm/ezr/blob/main/LICENSE.md"> <img
alt="License" src="https://img.shields.io/badge/license-bsd2-green"></a> <img 
src="https://img.shields.io/badge/purpose-ai%20,%20se-blueviolet"> <img
alt="Purpose" src="https://img.shields.io/badge/language-python3-blue">

<p><em>20-40 samples can find significant improvements in 10,000+ examples. Wanna know how?</em><hr>
<header id="title-block-header">
<h1 class="title">A quick peek at exr.py</h1>
<p class="author">Tim Menzies</p>
<p class="date">August 5, 2024</p>
</header>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#before-we-start." id="toc-before-we-start."><span
class="toc-section-number">1</span> Before We Start….</a></li>
<li><a href="#overview" id="toc-overview"><span
class="toc-section-number">2</span> Overview</a>
<ul>
<li><a href="#ezr-is-an-active-learning"
id="toc-ezr-is-an-active-learning"><span
class="toc-section-number">2.1</span> EZR is an active learning</a></li>
<li><a href="#se-examples-where-finding-x-is-cheaper-than-y"
id="toc-se-examples-where-finding-x-is-cheaper-than-y"><span
class="toc-section-number">2.2</span> SE Examples where finding <span
class="math inline">\(X\)</span> is cheaper than <span
class="math inline">\(Y\)</span></a></li>
<li><a href="#smart-labeling" id="toc-smart-labeling"><span
class="toc-section-number">2.3</span> Smart Labeling</a></li>
<li><a href="#training-data" id="toc-training-data"><span
class="toc-section-number">2.4</span> Training Data</a></li>
</ul></li>
<li><a href="#ai-notes" id="toc-ai-notes"><span
class="toc-section-number">3</span> AI Notes</a>
<ul>
<li><a href="#aggregation-functions"
id="toc-aggregation-functions"><span
class="toc-section-number">3.1</span> Aggregation Functions</a></li>
<li><a href="#configuration" id="toc-configuration"><span
class="toc-section-number">3.2</span> Configuration</a></li>
<li><a href="#classes" id="toc-classes"><span
class="toc-section-number">3.3</span> Classes</a></li>
<li><a href="#smarts" id="toc-smarts"><span
class="toc-section-number">3.4</span> Smarts</a>
<ul>
<li><a href="#bayes-classifier" id="toc-bayes-classifier"><span
class="toc-section-number">3.4.1</span> Bayes classifier</a></li>
<li><a href="#active-learner" id="toc-active-learner"><span
class="toc-section-number">3.4.2</span> Active Learner</a></li>
</ul></li>
</ul></li>
<li><a href="#se-notes" id="toc-se-notes"><span
class="toc-section-number">4</span> SE notes:</a>
<ul>
<li><a href="#architectural-styles" id="toc-architectural-styles"><span
class="toc-section-number">4.1</span> Architectural Styles</a>
<ul>
<li><a href="#social-patterns-coding-for-teams"
id="toc-social-patterns-coding-for-teams"><span
class="toc-section-number">4.1.1</span> Social patterns: Coding for
Teams</a></li>
<li><a href="#pattern-all-code-need-doco"
id="toc-pattern-all-code-need-doco"><span
class="toc-section-number">4.1.2</span> Pattern: All code need
doco</a></li>
<li><a href="#pattern-all-code-needs-tests"
id="toc-pattern-all-code-needs-tests"><span
class="toc-section-number">4.1.3</span> Pattern: All code needs
tests</a></li>
<li><a href="#pattern-configuration"
id="toc-pattern-configuration"><span
class="toc-section-number">4.1.4</span> Pattern: Configuration</a></li>
<li><a href="#pattern-function-vs-object-oriented"
id="toc-pattern-function-vs-object-oriented"><span
class="toc-section-number">4.1.5</span> Pattern: Function vs
Object-Oriented</a></li>
<li><a href="#pattern-dry-not-wet" id="toc-pattern-dry-not-wet"><span
class="toc-section-number">4.1.6</span> Pattern: DRY, not WET</a></li>
<li><a href="#pattern-little-languages"
id="toc-pattern-little-languages"><span
class="toc-section-number">4.1.7</span> Pattern: Little Languages</a>
<ul>
<li><a href="#little-languages-make"
id="toc-little-languages-make"><span
class="toc-section-number">4.1.7.1</span> Little Languages:
Make</a></li>
<li><a href="#little-languages-regular-expressions"
id="toc-little-languages-regular-expressions"><span
class="toc-section-number">4.1.7.2</span> Little Languages: Regular
Expressions</a></li>
</ul></li>
</ul></li>
<li><a href="#validation" id="toc-validation"><span
class="toc-section-number">4.2</span> Validation</a></li>
<li><a href="#python-idioms" id="toc-python-idioms"><span
class="toc-section-number">4.3</span> Python Idioms</a>
<ul>
<li><a href="#magic-methods" id="toc-magic-methods"><span
class="toc-section-number">4.3.1</span> Magic Methods</a></li>
<li><a href="#data-classes" id="toc-data-classes"><span
class="toc-section-number">4.3.2</span> Data classes</a></li>
<li><a href="#type-hints" id="toc-type-hints"><span
class="toc-section-number">4.3.3</span> Type hints</a></li>
<li><a href="#abstraction" id="toc-abstraction"><span
class="toc-section-number">4.3.4</span> Abstraction</a>
<ul>
<li><a href="#exception-handling" id="toc-exception-handling"><span
class="toc-section-number">4.3.4.1</span> Exception Handling</a></li>
<li><a href="#iterators" id="toc-iterators"><span
class="toc-section-number">4.3.4.2</span> Iterators</a></li>
</ul></li>
<li><a href="#comprehensions" id="toc-comprehensions"><span
class="toc-section-number">4.3.5</span> Comprehensions</a></li>
<li><a href="#decorators" id="toc-decorators"><span
class="toc-section-number">4.3.6</span> Decorators</a></li>
</ul></li>
</ul></li>
<li><a href="#try-it-for-yourself" id="toc-try-it-for-yourself"><span
class="toc-section-number">5</span> Try it for yourself</a>
<ul>
<li><a href="#get-python3.13" id="toc-get-python3.13"><span
class="toc-section-number">5.1</span> Get Python3.13</a></li>
<li><a href="#try-one-run" id="toc-try-one-run"><span
class="toc-section-number">5.2</span> Try one run</a></li>
<li><a href="#try-a-longer-run" id="toc-try-a-longer-run"><span
class="toc-section-number">5.3</span> Try a longer run</a></li>
<li><a href="#write-your-own-extensions"
id="toc-write-your-own-extensions"><span
class="toc-section-number">5.4</span> Write your own extensions</a></li>
</ul></li>
</ul>
</nav>
<h2 data-number="1" id="before-we-start."><span
class="header-section-number">1</span> Before We Start….</h2>
<p>Macro structure of ezr.py:</p>
<ul>
<li>Starts with <strong>doc</strong> string, from which we parse out the
control settings.</li>
<li>Ends with a set of examples in the <code>egs</code> class which can
be called from the command line. E.g. <code>-e mqs</code> called
<code>egs.mqs()</code>.</li>
<li>Uses a <a href="#decorators">a function-oriented style</a>, where
methods are grouped by name, not class.</li>
</ul>
<p>Terminology (watch for these words):</p>
<ul>
<li>Classes:
<ul>
<li>SETTINGS, DATA, COLS, NUM, SYM</li>
</ul></li>
<li>Variables:
<ul>
<li>row, rows, done (which divides into best and rest); todo</li>
</ul></li>
<li>SE Notes:
<ul>
<li>refactoring, DRY, WET</li>
<li>styles, patterns, idioms, function-oriented</li>
<li>decorators, little languages, configuration, pipes, iterators,
exception handling,</li>
<li>make, regular expressions,</li>
<li>decorators, type-hints, comprehensions, dunder methods,</li>
</ul></li>
<li>AI Notes:
<ul>
<li>Y, dependent, X, independent, goals,</li>
<li>labelling, active learning,</li>
<li>multi-objective, aggregation function, chebyshev</li>
<li>regression, classification, Bayes classifier,</li>
<li>entropy, standard deviation, cross-validation</li>
</ul></li>
<li>Synonyms (conflations, to be aware of):
<ul>
<li>features, attributes, goals</li>
<li>Y goals dependent</li>
<li>X independent</li>
<li>styles, patterns, idioms</li>
</ul></li>
</ul>
<h2 data-number="2" id="overview"><span
class="header-section-number">2</span> Overview</h2>
<h3 data-number="2.1" id="ezr-is-an-active-learning"><span
class="header-section-number">2.1</span> EZR is an active learning</h3>
<p>The human condition is that we have to make it up as we go along.
Active learning is a strategy for acting with partial knowledge, before
all the facts are in.</p>
<p>To understand this, suppose we wanted to learn some model <span
class="math inline">\(f\)</span></p>
<p><span
class="math display">\[Y_1,Y_2,...\;=\;f(X_1,X_2,X_3....)\]</span></p>
<p>Any example contains zero or more <span
class="math inline">\(X\)</span> and <span
class="math inline">\(Y\)</span> values</p>
<ul>
<li>If there are no <span class="math inline">\(Y\)</span> values, we
say the example is <em>unlabeled</em>.</li>
<li>If the model is any good then there must be some connection between
the <span class="math inline">\(X\)</span>s and the <span
class="math inline">\(Y\)</span>.
<ul>
<li>This means we can explore the <span class="math inline">\(X\)</span>
space to build a loosey-goosey approximate of the <span
class="math inline">\(Y\)</span> space.</li>
</ul></li>
<li>It is usually harder (slower, more expensive) to find the <span
class="math inline">\(Y\)</span>s than the <span
class="math inline">\(X\)</span>s. For example,
<ul>
<li>If we want to buy a used car then a single glance at a car lot tells
us much about hundreds of car make, model, color, number of doors, ages
of cars, etc (these are the <span class="math inline">\(X\)</span>
values)</li>
<li>But it takes much longer to work out acceleration or miles per hour
(these are the <span class="math inline">\(Y\)</span> values) since that
requires you have to drive the car around for a few hours.</li>
</ul></li>
</ul>
<h3 data-number="2.2"
id="se-examples-where-finding-x-is-cheaper-than-y"><span
class="header-section-number">2.2</span> SE Examples where finding <span
class="math inline">\(X\)</span> is cheaper than <span
class="math inline">\(Y\)</span></h3>
<ul>
<li><span class="math inline">\(X\)</span>,<span
class="math inline">\(Y\)</span> are our independent and dependent
variables.</li>
<li>Quick to mine <span class="math inline">\(X\)</span> GitHub to get
code size, dependencies per function,
<ul>
<li>Slow to get <span class="math inline">\(Y\)</span> (a) development
time, (b) what people will pay for it</li>
</ul></li>
<li>Quick to count <span class="math inline">\(X\)</span> the number of
classes in a system.
<ul>
<li>Slow to get <span class="math inline">\(Y\)</span> an organization
to tell you human effort to build and maintain that code.</li>
</ul></li>
<li>Quick to enumerate <span class="math inline">\(X\)</span> many
design options (20 yes-no = <span class="math inline">\(2^{20}\)</span>
options)
<ul>
<li>Slow to check <span class="math inline">\(Y\)</span> those options
with the human stakeholders.</li>
</ul></li>
<li>Quick to list <span class="math inline">\(X\)</span> configuration
parameters for the software.
<ul>
<li>Slow to find <span class="math inline">\(X\)</span> runtime and
energy requirements for all configurations.</li>
</ul></li>
<li>Quick to list <span class="math inline">\(X\)</span> data miner
params (e.g. how many neighbors in knn?)
<ul>
<li>Slow to find <span class="math inline">\(Y\)</span> best setting for
local data.</li>
</ul></li>
<li>Quick to make <span class="math inline">\(X\)</span> test case
inputs using (e.g.) random input selection
<ul>
<li>Slow to run all tests and get <span class="math inline">\(Y\)</span>
humans to check each output</li>
</ul></li>
</ul>
<h3 data-number="2.3" id="smart-labeling"><span
class="header-section-number">2.3</span> Smart Labeling</h3>
<ul>
<li>Learning works better if the learner can pick its training
data[^brochu].</li>
<li><em>Labeling</em> is the process of finding the <span
class="math inline">\(Y\)</span> values, before we know the <span
class="math inline">\(f\)</span> function
<ul>
<li>So we have to do something slow and/or expensive to find the
label;s; e.g. ask an expert, go hunt for them in the real world.</li>
<li>The first time we find the <span class="math inline">\(Y\)</span>
values, that incurs a one-time cost</li>
<li>After that, the labels can be access for free.</li>
</ul></li>
<li>Just for simplicity, assume we a model can inputs <span
class="math inline">\(X\)</span> values to predict for good <span
class="math inline">\(g\)</span> or bad <span
class="math inline">\(b\)</span>:</li>
</ul>
<table>
<colgroup>
<col style="width: 12%" />
<col style="width: 43%" />
<col style="width: 43%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: right;">n</th>
<th style="text-align: center;">Task</th>
<th style="text-align: left;">Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: right;">1</td>
<td style="text-align: center;">Sample a little</td>
<td style="text-align: left;">Get a get a few <span
class="math inline">\(Y\)</span> values (picked at random?)</td>
</tr>
<tr class="even">
<td style="text-align: right;">2</td>
<td style="text-align: center;">Learn a little</td>
<td style="text-align: left;">Build a tiny model from that sample</td>
</tr>
<tr class="odd">
<td style="text-align: right;">3</td>
<td style="text-align: center;">Reflect</td>
<td style="text-align: left;">Compute <span
class="math inline">\(b,r\)</span></td>
</tr>
<tr class="even">
<td style="text-align: right;">4</td>
<td style="text-align: center;">Acquire</td>
<td style="text-align: left;">Label an example that (e.g.) maximizes
<span class="math inline">\(b/r\)</span> then it to the sample.</td>
</tr>
<tr class="odd">
<td style="text-align: right;">5</td>
<td style="text-align: center;">Repeat</td>
<td style="text-align: left;">Goto 2</td>
</tr>
</tbody>
</table>
<p>So, an active learner tries to learn <span
class="math inline">\(f\)</span> using a lot of cheap <span
class="math inline">\(X\)</span> values, but very few <span
class="math inline">\(Y\)</span> values– since they are more expensive
to access. Active learners know that they can learn better (faster, with
fewer <span class="math inline">\(Y\)</span> values) if they can select
their own training data:</p>
<ul>
<li>Given what we have seen so far…</li>
<li>Active learners guess what is be the next more informative <span
class="math inline">\(Y\)</span> labels to collect..</li>
</ul>
<h3 data-number="2.4" id="training-data"><span
class="header-section-number">2.4</span> Training Data</h3>
<p>Active learners spend much time reasoning about the <span
class="math inline">\(X\)</span> values (which are cheap to collect)
before deciding which dependent variables to collect next. A repeated
result is that this tactic can produce good models, with minimal
information about the dependent variables.</p>
<p>For training purposes we explore all this using csv files where “?”
denotes missing values. Row one list the columns names, defining the
roles of the columns:</p>
<ul>
<li>NUMeric column names start with an upper case letter.</li>
<li>All other columns are SYMbolic.</li>
<li>Names ending with “+” or “-” are goals to maximize/minimize</li>
<li>Anything ending in “X” is a column we should ignore.</li>
</ul>
<p>For example, here is data where the goals are
<code>Lbs-,Acc+,Mpg+</code> i.e. we want to minimize car weight and
maximize acceleration and maximize fuel consumption.</p>
<pre><code> Clndrs   Volume  HpX  Model  origin  Lbs-  Acc+  Mpg+
 -------  ------  ---  -----  ------  ----  ----  ----
  4       90      48   78     2       1985  21.5   40
  4       98      79   76     1       2255  17.7   30
  4       98      68   77     3       2045  18.5   30
  4       79      67   74     2       2000  16     30
  ...
  4      151      85   78     1       2855  17.6   20
  6      168      132  80     3       2910  11.4   30
  8      350      165  72     1       4274  12     10
  8      304      150  73     1       3672  11.5   10
  ------------------------------      ----------------
    independent features (x)          dependent goals (y)</code></pre>
<p>Note that the top rows are better than the bottom ones (lighter,
faster cars that are more economical).</p>
<ul>
<li>Multi-objective learners find a model that selects for the best
rows, based on multiple goal.s
<ul>
<li>Aside: most learners support single objective classifiers (for one
symbolic column) or regression (for one numeric column).</li>
</ul></li>
<li>EZR’s active learner, does the same multi-objective task, but with
very few peeks at the goal y values.
<ul>
<li>Why? Since it usually very cheap to get <code>X</code> but very
expensive to get <code>Y</code>.</li>
</ul></li>
</ul>
<p>For testing purposes here, all the examples explored here come with
all their <span class="math inline">\(Y\)</span> values.</p>
<ul>
<li>We just take great care in the code to record how many rows we use
to look up <span class="math inline">\(Y\)</span> labels.</li>
</ul>
<h2 data-number="3" id="ai-notes"><span
class="header-section-number">3</span> AI Notes</h2>
<h3 data-number="3.1" id="aggregation-functions"><span
class="header-section-number">3.1</span> Aggregation Functions</h3>
<p>To sort the data, all the goals have to be aggregated into one
function. Inspired by the MOEA/D algorithm<a href="#fn1"
class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>,
EZR uses the Chebyshev function that returns the max difference between
the goal values and the best possible values. The rows shown above are
sorted top to bottom, least to most Chebyshev values (so the best rows,
with smallest Chebyshev, are shown at top).</p>
<p>Chebyshev is very simple to code. We assume a lost of goal columns
<code>self.cols.y</code> each of which knows:</p>
<ul>
<li>its column index <code>col.at</code></li>
<li>How to <code>norm</code>alize values 0..1, min..max using
<code>col.norm(x)</code></li>
<li>What is the best value <code>col.goal</code>:
<ul>
<li>For goals to minimize, like “Lbs-”, <code>goal=0</code>.</li>
<li>For goals to maximize, like “Mpg+”, <code>goal=1</code>.</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb2"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="at">@of</span>(<span class="st">&quot;Compute Chebyshev distance of one row to the best `y` values.&quot;</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> chebyshev(<span class="va">self</span>:DATA,row:row) <span class="op">-&gt;</span> number:</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span>  <span class="bu">max</span>(<span class="bu">abs</span>(col.goal <span class="op">-</span> col.norm(row[col.at])) <span class="cf">for</span> col <span class="kw">in</span> <span class="va">self</span>.cols.y)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="at">@of</span>(<span class="st">&quot;Returns 0..1 for min..max.&quot;</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> norm(<span class="va">self</span>:NUM, x) <span class="op">-&gt;</span> number:</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> x <span class="cf">if</span> x<span class="op">==</span><span class="st">&quot;?&quot;</span> <span class="cf">else</span>  ((x <span class="op">-</span> <span class="va">self</span>.lo) <span class="op">/</span> (<span class="va">self</span>.hi <span class="op">-</span> <span class="va">self</span>.lo <span class="op">+</span> <span class="fl">1E-32</span>))</span></code></pre></div>
<p>When we say “rank DATA”, we mean sort all the rows by their Chebyshev
distance:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="at">@of</span>(<span class="st">&quot;Sort rows by the Euclidean distance of the goals to heaven.&quot;</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> chebyshevs(<span class="va">self</span>:DATA) <span class="op">-&gt;</span> DATA:</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="va">self</span>.rows <span class="op">=</span> <span class="bu">sorted</span>(<span class="va">self</span>.rows, key<span class="op">=</span><span class="kw">lambda</span> r: <span class="va">self</span>.chebyshev(r))</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="va">self</span></span></code></pre></div>
<h3 data-number="3.2" id="configuration"><span
class="header-section-number">3.2</span> Configuration</h3>
<p>Other people define their command line options separate to the
settings. That is they have to define all those settings twice</p>
<p>This code parses the settings from the <strong>doc</strong> string
(see the SETTINGS class). So the help text and the definitions of the
options can never go out of sync.</p>
<h3 data-number="3.3" id="classes"><span
class="header-section-number">3.3</span> Classes</h3>
<p>This code has only a few main classes: SETTINGS, DATA, COLS, NUM,
SYM</p>
<ul>
<li>SETTINGS handles the config settings.
<ul>
<li>The code can access these settings via the <code>the</code> variable
(so <code>the = SETTINGS()</code>).</li>
</ul></li>
<li>NUM, SYM, COL (the super class of NUM,SYM). These classes summarize
each column.
<ul>
<li>NUMs know mean and standard deviation (a measure of average distance
of numbers to the mean)
<ul>
<li><span class="math inline">\(\sigma=\sqrt{\frac{1}{N-1} \sum_{i=1}^N
(x_i-\overline{x})^2}\)</span></li>
</ul></li>
<li>SYMs know mode (most common symbol) and entropy (a measure of how
often we see different symbols)
<ul>
<li>entropy = <span class="math inline">\(-\sum_{i=1}^n p(x_i) \log_2
p(x_i)\)</span></li>
</ul></li>
<li>Mean and mode are both measures of central tendency</li>
<li>Entropy and standard deviation are measures of confusion.
<ul>
<li>The lower their values, the more likely we can believe in the
central tendency</li>
</ul></li>
</ul></li>
<li>DATA stores <code>rows</code>, summarized in <code>cols</code>
(columns).</li>
<li>COLS is a factory that takes a list of names and creates the
columns.
<ul>
<li>All the columns are stored in <code>all</code> (and some are also
stored in <code>x</code> and <code>y</code>).</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb4"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> COLS:</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  names: <span class="bu">list</span>[<span class="bu">str</span>]   <span class="co"># column names</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="bu">all</span>  : <span class="bu">list</span>[COL] <span class="op">=</span> LIST()  <span class="co"># all NUMS and SYMS</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  x    : <span class="bu">list</span>[COL] <span class="op">=</span> LIST()  <span class="co"># independent COLums</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  y    : <span class="bu">list</span>[COL] <span class="op">=</span> LIST()  <span class="co"># dependent COLumns</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  klass: COL <span class="op">=</span> <span class="va">None</span></span></code></pre></div>
<p>To build the columns, COLS looks at each name’s <code>a,z</code>
(first and last letter).</p>
<ul>
<li>e.g. <code>['Clndrs', 'Volume', 'HpX', 'Model','origin', 'Lbs-', 'Acc+',  'Mpg+']</code></li>
</ul>
<div class="sourceCode" id="cb5"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> __post_init__(<span class="va">self</span>:COLS) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> at,txt <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="va">self</span>.names):</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>      a,z <span class="op">=</span> txt[<span class="dv">0</span>],txt[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>      col <span class="op">=</span> (NUM <span class="cf">if</span> a.isupper() <span class="cf">else</span> SYM)(at<span class="op">=</span>at, txt<span class="op">=</span>txt)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>      <span class="va">self</span>.<span class="bu">all</span>.append(col)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> z <span class="op">!=</span> <span class="st">&quot;X&quot;</span>:</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>        (<span class="va">self</span>.y <span class="cf">if</span> z <span class="kw">in</span> <span class="st">&quot;!+-&quot;</span> <span class="cf">else</span> <span class="va">self</span>.x).append(col)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> z<span class="op">==</span><span class="st">&quot;!&quot;</span>: <span class="va">self</span>.klass <span class="op">=</span> col</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> z<span class="op">==</span><span class="st">&quot;-&quot;</span>: col.goal <span class="op">=</span> <span class="dv">0</span></span></code></pre></div>
<h3 data-number="3.4" id="smarts"><span
class="header-section-number">3.4</span> Smarts</h3>
<h4 data-number="3.4.1" id="bayes-classifier"><span
class="header-section-number">3.4.1</span> Bayes classifier</h4>
<p>When you have labels, a simple and fast technique is:</p>
<ul>
<li>Divide the rows into different labels,</li>
<li>Collect statistics independently for each label. For us, this means
building one DATA for each label.</li>
<li>Then ask how likely is a row to belong to each DATA?
<ul>
<li>Internally, this will become a recursive call asking how likely am I
to belong to each <em>x</em> column of the data</li>
</ul></li>
</ul>
<p>The probability of <code>x</code> belong to a column is pretty
simple:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="at">@of</span>(<span class="st">&quot;How much a SYM likes a value `x`.&quot;</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> like(<span class="va">self</span>:SYM, x:<span class="bu">any</span>, prior:<span class="bu">float</span>) <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> (<span class="va">self</span>.has.get(x,<span class="dv">0</span>) <span class="op">+</span> the.m<span class="op">*</span>prior) <span class="op">/</span> (<span class="va">self</span>.n <span class="op">+</span> the.m)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="at">@of</span>(<span class="st">&quot;How much a NUM likes a value `x`.&quot;</span>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> like(<span class="va">self</span>:NUM, x:number, _) <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  v     <span class="op">=</span> <span class="va">self</span>.sd<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> <span class="fl">1E-30</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  nom   <span class="op">=</span> exp(<span class="op">-</span><span class="dv">1</span><span class="op">*</span>(x <span class="op">-</span> <span class="va">self</span>.mu)<span class="op">**</span><span class="dv">2</span><span class="op">/</span>(<span class="dv">2</span><span class="op">*</span>v)) <span class="op">+</span> <span class="fl">1E-30</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  denom <span class="op">=</span> (<span class="dv">2</span><span class="op">*</span>pi<span class="op">*</span>v) <span class="op">**</span><span class="fl">0.5</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="bu">min</span>(<span class="dv">1</span>, nom<span class="op">/</span>(denom <span class="op">+</span> <span class="fl">1E-30</span>))</span></code></pre></div>
<p>The likelihood of a row belonging to a label, given new evidence, is
the prior probability of the label times the probability of the
evidence. For example, if we have three oranges and six apples, then the
prior on oranges is 33%.</p>
<p>For numerical methods reasons, we add tiny counts to the attribute
and class frequencies (<span class="math inline">\(k=1,m=2\)</span>) and
treat all the values as logarithms (since these values can get real
small, real fast)</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="at">@of</span>(<span class="st">&quot;How much DATA likes a `row`.&quot;</span>)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> loglike(<span class="va">self</span>:DATA, r:row, nall:<span class="bu">int</span>, nh:<span class="bu">int</span>) <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  prior <span class="op">=</span> (<span class="bu">len</span>(<span class="va">self</span>.rows) <span class="op">+</span> the.k) <span class="op">/</span> (nall <span class="op">+</span> the.k<span class="op">*</span>nh)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  likes <span class="op">=</span> [c.like(r[c.at], prior) <span class="cf">for</span> c <span class="kw">in</span> <span class="va">self</span>.cols.x <span class="cf">if</span> r[c.at] <span class="op">!=</span> <span class="st">&quot;?&quot;</span>]</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="bu">sum</span>(log(x) <span class="cf">for</span> x <span class="kw">in</span> likes <span class="op">+</span> [prior] <span class="cf">if</span> x<span class="op">&gt;</span><span class="dv">0</span>)</span></code></pre></div>
<h4 data-number="3.4.2" id="active-learner"><span
class="header-section-number">3.4.2</span> Active Learner</h4>
<p>The active learner uses a Bayes classifier to guess the likelihood
that an unlabeled example should be labeled next.</p>
<ol type="1">
<li>All the unlabeled data is split into a tiny <code>done</code> set
and a much larger <code>todo</code> set</li>
<li>All the <code>done</code>s are labeled, then ranked, then divided
into <span class="math inline">\(\sqrt{N}\)</span> <em>best</em> and
<span class="math inline">\(1-\sqrt{N}\)</span> <em>rest</em>.</li>
<li>Some sample of the <code>todo</code>s are the sorted by their
probabilities of being <em>best</em> (B), not <em>rest</em> (R)
<ul>
<li>The following code uses <span
class="math inline">\(B-R\)</span></li>
<li>But these values ore logs so this is really <span
class="math inline">\(B/R\)</span>.</li>
</ul></li>
<li>The top item in that sort is then labelled and move to done.
<ul>
<li>And the cycle repeats</li>
</ul></li>
</ol>
<div class="sourceCode" id="cb8"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="at">@of</span>(<span class="st">&quot;active learning&quot;</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> activeLearning(<span class="va">self</span>:DATA, score<span class="op">=</span><span class="kw">lambda</span> B,R: B<span class="op">-</span>R, generate<span class="op">=</span><span class="va">None</span>, faster<span class="op">=</span><span class="va">True</span> ):</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> ranked(rows): <span class="cf">return</span> <span class="va">self</span>.clone(rows).chebyshevs().rows</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> todos(todo):</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> faster: <span class="co"># Apply our sorting heuristics to just a small buffer at start of &quot;todo&quot;</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>       <span class="co"># Rotate back half of the buffer to end of list. Shift left to fill in the gap.</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>       n <span class="op">=</span> the.<span class="bu">buffer</span><span class="op">//</span><span class="dv">2</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>       <span class="cf">return</span> todo[:n] <span class="op">+</span> todo[<span class="dv">2</span><span class="op">*</span>n: <span class="dv">3</span><span class="op">*</span>n],  todo[<span class="dv">3</span><span class="op">*</span>n:] <span class="op">+</span> todo[n:<span class="dv">2</span><span class="op">*</span>n]</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>: <span class="co"># Apply our sorting heustics to all of todo.</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> todo,[]</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> guess(todo:rows, done:rows) <span class="op">-&gt;</span> rows:</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    cut  <span class="op">=</span> <span class="bu">int</span>(<span class="fl">.5</span> <span class="op">+</span> <span class="bu">len</span>(done) <span class="op">**</span> the.cut)</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    best <span class="op">=</span> <span class="va">self</span>.clone(done[:cut])  <span class="co"># --------------------------------------------------- [2]</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>    rest <span class="op">=</span> <span class="va">self</span>.clone(done[cut:])</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    a,b  <span class="op">=</span> todos(todo) </span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> generate: <span class="co"># don&#39;t worry about this bit</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> <span class="va">self</span>.neighbors(generate(best,rest), a) <span class="op">+</span> b  <span class="co"># ----------------------------- [3]</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>      key  <span class="op">=</span> <span class="kw">lambda</span> r: score(best.loglike(r, <span class="bu">len</span>(done), <span class="dv">2</span>), rest.loglike(r, <span class="bu">len</span>(done), <span class="dv">2</span>))</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span>  <span class="bu">sorted</span>(a, key<span class="op">=</span>key, reverse<span class="op">=</span><span class="va">True</span>) <span class="op">+</span> b <span class="co"># ----------------------------------- [3]</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> loop(todo:rows, done:rows) <span class="op">-&gt;</span> rows:</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> k <span class="kw">in</span> <span class="bu">range</span>(the.Last <span class="op">-</span> the.label):</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="bu">len</span>(todo) <span class="op">&lt;</span> <span class="dv">3</span> : <span class="cf">break</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>      top,<span class="op">*</span>todo <span class="op">=</span> guess(todo, done)</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>      done     <span class="op">+=</span> [top]   <span class="co"># ------------------------------------------------------------ [3]</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>      done      <span class="op">=</span> ranked(done)</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> done</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> loop(<span class="va">self</span>.rows[the.label:], ranked(<span class="va">self</span>.rows[:the.label])) <span class="co">#------------------- [1]</span></span></code></pre></div>
<p>The default configs here is <code>the.label=4</code> and
<code>the.Last=30</code>; i.e. four initial evaluations, then 26 evals
after that.</p>
<p>TL;DR: to explore better methods for active learning:</p>
<ul>
<li>change the <code>guess()</code> function</li>
<li>and do something, anything with the unlabeled <code>todo</code>
items (looking only at the x values, not the y values).</li>
</ul>
<h2 data-number="4" id="se-notes"><span
class="header-section-number">4</span> SE notes:</h2>
<p>Programming <em>idioms</em> are low-level patterns specific to a
particular programming language. For example, see <a
href="#decorators">decorators</a> which are a Python construct</p>
<p>Idioms are small things. Bigger than idioms are <em>patterns</em> :
elegant solution to a recurring problem. Some folks have proposed <a
href="https://en.wikipedia.org/wiki/Software_design_pattern">extensive
catalogs of patterns</a>. These are worth reading. As for me, patterns
are things I reuse whenever I do development in any languages. This code
uses many patterns (see below).</p>
<p>Even bigger than patterns are <em>architectural style</em> is a
high-level conceptual view of how the system will be created, organized
and/or operated.</p>
<h3 data-number="4.1" id="architectural-styles"><span
class="header-section-number">4.1</span> Architectural Styles</h3>
<p>This code is <code>pipe and filter</code>. It can accept code from
some prior process or if can read a file directly. These two calls are
equivalent (since “-” denotes standard input). This pile-and-filter
style is important since</p>
<pre><code>python3.13 -B ezr.py -t ../moot/optimize/misc/auto93.csv -e _mqs
cat ../moot/optimize/misc/auto93.csv | python3.13 -B ezr.py -t -  -e _mqs</code></pre>
<p>(Aside: to see how to read from standard input or a file, see
<code>def csv</code> in the source code.)</p>
<p>Pipe-and-filters are a very famous architectural style:</p>
<blockquote>
<p>Doug McIlroy, Bell Labs, 1986: <em>“We should have some ways of
coupling programs like garden hose…. Let programmers screw in another
segment when it becomes necessary to massage data in another way….
Expect the output of every program to become the input to another, as
yet unknown, program. Don’t clutter output with extraneous
information.”</em></p>
</blockquote>
<p>Pipes changed the whole idea of UNIX:</p>
<ul>
<li>Implemented in 1973 when (“in one feverish night”, wrote McIlroy) by
Ken Thompson.</li>
<li>“It was clear to everyone, practically minutes after the system came
up with pipes working, that it was a wonderful thing. Nobody would ever
go back and give that up if they could.”</li>
<li>The next day”, McIlroy writes, “saw an unforgettable orgy of
one-liners as everybody joined in the excitement of plumbing.”</li>
</ul>
<p>For example, my build files have help text after a <code>##</code>
symbol. The following script prints a little help text describing that
build script. It is a pipe between grep, sort, and awk Note the
separation of concerns (which means that now our task divides into tiny
tasks, each of which can be optimized separately):</p>
<ul>
<li><code>grep</code> handles feature extraction from the build
file;</li>
<li><code>sort</code> rearranges the contents alphabetically</li>
<li><code>gawk</code> handles some formatting trivia.</li>
</ul>
<div class="sourceCode" id="cb10"><pre
class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="dv">help:</span><span class="dt"> </span><span class="co">## print help</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="er">    </span>printf <span class="st">&quot;\n#readme\nmake [OPTIONS]\n\nOPTIONS:\n&quot;</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    grep -E <span class="st">&#39;^[a-zA-Z_\.-]+:.*?## .*</span><span class="ch">$$</span><span class="st">&#39;</span> <span class="ch">$(</span><span class="dt">MAKEFILE_LIST</span><span class="ch">)</span> \</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>        | sort \</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>        | awk <span class="st">&#39;BEGIN {FS = &quot;:.*?## &quot;}\</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="st">                   {printf &quot;  \033[36m%-10s\033[0m %s\n&quot;, </span><span class="ch">$$</span><span class="st">1, </span><span class="ch">$$</span><span class="st">2}&#39;</span></span></code></pre></div>
<p>This produces:</p>
<pre><code>% make help

#readme
make [OPTIONS]

OPTIONS:
  README.md  update README.md, publish
  help       print help
  push       commit to Git. </code></pre>
<p>Pipes are seen in scripting environments and are used a lot in modern
languages.e .g. in “R”. Compare how many gallons of gas I would need for
a 75 mile trip among 4-cylinder cars:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr) <span class="co"># load dplyr for the pipe and other tidy functions</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(mtcars) <span class="co"># load the mtcars dataset</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> mtcars <span class="sc">%&gt;%</span>               <span class="co"># take mtcars. AND THEN...</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(cyl <span class="sc">==</span> <span class="dv">4</span>) <span class="sc">%&gt;%</span>       <span class="co"># filter it to four-cylinder cars, AND THEN...</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(mpg) <span class="sc">%&gt;%</span>            <span class="co"># select only the mpg column, AND THEN...</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">car =</span> <span class="fu">row.names</span>(.), <span class="co"># add a column for car name and # gallons used on a 75 mile trip</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">gallons =</span> mpg<span class="sc">/</span><span class="dv">75</span>)</span></code></pre></div>
<h4 data-number="4.1.1" id="social-patterns-coding-for-teams"><span
class="header-section-number">4.1.1</span> Social patterns: Coding for
Teams</h4>
<p>This code is poorly structured for team work:</p>
<ul>
<li>For teams, better to have tests in separate file(s)
<ul>
<li>If multiple test files, then many people can write their own special
tests</li>
<li>When tests are platform-dependent, it is good to be able to modify
the tests without modifying the main thing;</li>
</ul></li>
<li>For teams, better to have code in multiple files:
<ul>
<li>so different people can work in separate files (less chance of edit
conclusions)</li>
</ul></li>
<li>This code violates known <a
href="https://peps.python.org/pep-0008/">Python formatting standards
(PEP 8)</a> which is supported by so many tools; e.g. <a
href="https://github.com/psf/black">Black</a> and <a
href="https://code.visualstudio.com/docs/python/formatting">various
tools in VScode</a>
<ul>
<li>Consider to have commit hooks to re-format the code to something
more usual</li>
</ul></li>
<li>My use of the <a href="#decorators">of</a> is highly non-standard.
Teams would probably want to change that.</li>
</ul>
<h4 data-number="4.1.2" id="pattern-all-code-need-doco"><span
class="header-section-number">4.1.2</span> Pattern: All code need
doco</h4>
<p>Code has much auto-documentation - functions have type hints and doc
strings - help string at front (from which we parse out the config) -
worked examples (at back)</p>
<p>For examples of methods for adding that doco, see
<code>make help</code> command above.</p>
<h4 data-number="4.1.3" id="pattern-all-code-needs-tests"><span
class="header-section-number">4.1.3</span> Pattern: All code needs
tests</h4>
<blockquote>
<p>Maurice Wilkes recalled the exact moment he realized the importance
of debugging: <em>“By June 1949, people had begun to realize that it was
not so easy to get a program right as had at one time appeared. It was
on one of my journeys between the EDSAC room and the punching equipment
that the realization came over me with full force that a good part of
the remainder of my life was going to be spent in finding errors in my
own programs.”</em></p>
</blockquote>
<p>Half the time of any system is spent in testing. Lesson: don’t code
it the night before.</p>
<p>Testing is more than just “finding bugs”. Test suites are a great way
to communicate code and to offer continuous quality assurances.</p>
<ul>
<li>Tests offer little lessons on how to use the code.</li>
<li>Teams sharing code can rerun the tests, all the time, to make sure
their new code does not break old code.
<ul>
<li>Caveat: that only works if the tests are fast unit tests.</li>
</ul></li>
</ul>
<p>Exr.py has tests (worked examples at back); about a quarter of the
code base</p>
<ul>
<li>any method eg.method can be called from the command line using.
e.g. to call egs.mqs:
<ul>
<li>python3 ezr.py -e mqs</li>
</ul></li>
</ul>
<p>There is much more to say about tests. That is another story and will
be told another time.</p>
<h4 data-number="4.1.4" id="pattern-configuration"><span
class="header-section-number">4.1.4</span> Pattern: Configuration</h4>
<ul>
<li>All code has config settings. Magic numbers should not be buried in
the code. They should be adjustable from the command line (allows for
easier experimentation).</li>
<li>BTW, handling the config gap is a real challenge. Rate of new config
grows much faser than rate that people understanding those options<a
href="#fn2" class="footnote-ref" id="fnref2"
role="doc-noteref"><sup>2</sup></a>. Need active learning To explore
that exponentially large sapce!</li>
</ul>
<h4 data-number="4.1.5" id="pattern-function-vs-object-oriented"><span
class="header-section-number">4.1.5</span> Pattern: Function vs
Object-Oriented</h4>
<p>Object-oriented code is groups by class. But some folks doubt that
approach:</p>
<ul>
<li><a
href="https://www.researchgate.net/publication/3247400_Does_OO_sync_with_how_we_think">Does
OO Sync With the Way we Think?</a></li>
<li><a href="https://www.youtube.com/watch?v=o9pEzgHorH0">Stop writing
classes</a></li>
</ul>
<p>My code is function-oriented: methods are grouped via method name
(see the <a href="#decorators">of</a> decorator). This makes it easier
to teach retlated concepts (since the concepts are together in the
code).</p>
<p>Me doing this way was inspired by some words of Donald Knth who
pointed out that the order with which we want to explains code may not
be the same the order needed by the compiler. So he wrote a “tangle”
system where code and comments, ordered for explaining, was rejigged at
load time into what the compiler needs. I found I could do a small part
of Knthu’s tangle with a <a href="#decorators">5 line decorator</a>.</p>
<h4 data-number="4.1.6" id="pattern-dry-not-wet"><span
class="header-section-number">4.1.6</span> Pattern: DRY, not WET</h4>
<ul>
<li>WET = Write everything twice.
<ul>
<li>Other people define their command line options separate to the
settings.<br />
</li>
<li>That is they have to define all those settings twice</li>
</ul></li>
<li>DRY = Dont’ repeat yourself.
<ul>
<li>This code parses the settings from the <strong>doc</strong> string
(see the SETTINGS class)</li>
<li>That is, my settings options are DRY.</li>
</ul></li>
<li>When to be DRY
<ul>
<li>If it only occurs once, then ok.</li>
<li>If you see it twice, just chill. You can be a little WET</li>
<li>if you see it thrice, refactor so “it” is defined only once, then
reused elsewhere</li>
</ul></li>
</ul>
<h4 data-number="4.1.7" id="pattern-little-languages"><span
class="header-section-number">4.1.7</span> Pattern: Little
Languages</h4>
<ul>
<li>Operate policy from mechanisms; i.e. the spec from the machinery
that uses the spec</li>
<li>Allows for faster adaption</li>
<li>In this code:
<ul>
<li>The column names is a “little language” defining objective
problems.</li>
<li>Parsing <strong>doc</strong> string makes that string a little
language defining setting options.</li>
<li>The SETTINGS class uses regular expressions to extract the settings
<ul>
<li>regular expressions are other “little languages”</li>
</ul></li>
<li>Another “not-so-little” little language: <a
href="https://learnxinyminutes.com/docs/make/">Makefiles</a> handles
dependencies and updates</li>
</ul></li>
</ul>
<h5 data-number="4.1.7.1" id="little-languages-make"><span
class="header-section-number">4.1.7.1</span> Little Languages: Make</h5>
<p>Make files let us store all our little command line tricks in one
convenient location. Make development was started by Stuart Feldman in
1977 as a Bell Labs summer intern (go interns!). It worthy of study
since it is widely available on many environments.</p>
<p>There are now many build tools available, for example Apache ANT,
doit, and nmake for Windows. Which is best for you depends on your
requirements, intended usage, and operating system. However, they all
share the same fundamental concepts as Make.</p>
<p>Make has “rules” and the rules have three parts: target, dependents
(which can be empty), and code to build the target from the dependents.
For example, the following two rules have code that simplifies our
interaction with git.</p>
<ul>
<li>The command <code>make pull</code> updates the local files (no big
win here)</li>
<li>The command <code>make push</code> uses <code>read</code> to collect
a string explaining what a git commit is for, then stages the commit,
then makes the commit, then checks for things that are not
committed.</li>
</ul>
<div class="sourceCode" id="cb13"><pre
class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="dv">pull    :</span><span class="dt"> </span><span class="co">## download</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="er">   </span>git pull</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="dv">push    :</span><span class="dt"> </span><span class="co">## save</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="er">  </span>echo -en <span class="st">&quot;\033[33mWhy this push? \033[0m&quot;</span>; read x; git commit -am <span class="st">&quot;</span><span class="ch">$$</span><span class="st">x&quot;</span>; git push; git status</span></code></pre></div>
<p>For rules with dependents, the target is not changed unless there are
newer dependents. For example, here is the rule that made this file.
Note that this process needs a bunch of scripts, a css file etc. Make
will udpate <code>docs/%.html</code> if ever any of those dependents
change.</p>
<div class="sourceCode" id="cb14"><pre
class="sourceCode makefile"><code class="sourceCode makefile"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="dv">docs/%.html :</span><span class="dt"> %.py etc/py2html.awk etc/b4.html docs/ezr.css Makefile </span><span class="co">## make doco: md -&gt; html</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="er">    </span>echo <span class="st">&quot;</span><span class="ch">$&lt;</span><span class="st"> ... &quot;</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    gawk -f etc/py2html.awk <span class="ch">$&lt;</span> \</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    | pandoc -s  -f markdown --number-sections --toc --toc-depth=5 \</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>                    <span class="ch">-</span><span class="fu">B etc/b4.html --mathjax </span><span class="ch">\</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="fu">             --css ezr.css --highlight-style tango </span><span class="ch">\</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="fu">                     --metadata title=</span><span class="st">&quot;</span><span class="ch">$&lt;</span><span class="st">&quot;</span><span class="fu"> </span><span class="ch">\</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="fu">                 -o </span><span class="ch">$@</span><span class="fu"> </span></span></code></pre></div>
<p>This means that <code>make docs/*.html</code> will update all the
html files at this site. And if we call this command twice, the second
call will do nothing at all since <code>docs/%.html</code> is already up
to date. This can save a lot of time during build procedures.</p>
<p>The makefile for any particular project can get very big. Hence, it s
good practice to add an auto document rule (see the
<code>make help</code> command, above). Note that this is an example of
the <em>all code needs doco</em> pattern (also described above).</p>
<h5 data-number="4.1.7.2"
id="little-languages-regular-expressions"><span
class="header-section-number">4.1.7.2</span> Little Languages: Regular
Expressions</h5>
<ul>
<li>Example of a “little language”</li>
<li>Used here to extract settings and their defaults from the
<code>__doc__</code> string
<ul>
<li>in SETTINGS, using <code>r"\n\s*-\w+\s*--(\w+).*=\s*(\S+)</code> (a
leading “r” tells Python to define a regular expression)</li>
</ul></li>
<li>Other, simpler Examples:
<ul>
<li>leading white space <code>^[ \t\n]*</code> (spare brackets means one
or more characters; star means zero or more)</li>
<li>trailing white space <code>[ \t\n]*$</code> (dollar sign means end
of line)</li>
<li>IEEE format number
<code>^[+-]?([0-9]+[.]?[0-9]*|[.][0-9]+)([eE][+-]?[0-9]+)?$</code>
(round brackets group expressions; vertical bar denotes “or”; “?” means
zero or one)</li>
</ul></li>
<li>Beautiful example, <a
href="https://github.com/timm/ezr/blob/main/docs/pdf/pakin1991.pdf">guessing
North Amererican Names using regualr expressions</a>
<ul>
<li>For a cheat sheet on regular expressions, see p64 of that
article)</li>
<li>For source code, see <a
href="https://github.com/timm/ezr/blob/main/etc/gender.awk">gender.awk</a></li>
</ul></li>
<li>For other articles on regular expressions:
<ul>
<li>At their core, they can be <a
href="http://genius.cat-v.org/brian-kernighan/articles/beautiful">surprisingly
simple</a></li>
<li>Fantastic article: <a
href="https://swtch.com/~rsc/regexp/regexp1.html">Regular Expression
Matching Can Be Simple And Fast</a>,</li>
</ul></li>
</ul>
<h3 data-number="4.2" id="validation"><span
class="header-section-number">4.2</span> Validation</h3>
<p>xval temoral XXX</p>
<h3 data-number="4.3" id="python-idioms"><span
class="header-section-number">4.3</span> Python Idioms</h3>
<h4 data-number="4.3.1" id="magic-methods"><span
class="header-section-number">4.3.1</span> Magic Methods</h4>
<p>Dunder = double underscore = “__”</p>
<p>XXX pos_init init repr</p>
<h4 data-number="4.3.2" id="data-classes"><span
class="header-section-number">4.3.2</span> Data classes</h4>
<p>This code uses dataclasses. These are a great shorthand method for
defining classes. All dataclasses supply their own init and pretty-print
methods. For example, here is a class with dataclasses</p>
<div class="sourceCode" id="cb15"><pre
class="sourceCode py"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Person():</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, name<span class="op">=</span><span class="st">&#39;Joe&#39;</span>, age<span class="op">=</span><span class="dv">30</span>, height<span class="op">=</span><span class="fl">1.85</span>, email<span class="op">=</span><span class="st">&#39;joe@dataquest.io&#39;</span>):</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.name <span class="op">=</span> name</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.age <span class="op">=</span> age</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.height <span class="op">=</span> height</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.email <span class="op">=</span> email</span></code></pre></div>
<p>Bt with data classes:</p>
<div class="sourceCode" id="cb16"><pre
class="sourceCode py"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dataclasses <span class="im">import</span> dataclass</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Person():</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    name: <span class="bu">str</span> <span class="op">=</span> <span class="st">&#39;Joe&#39;</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    age: <span class="bu">int</span> <span class="op">=</span> <span class="dv">30</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>    height: <span class="bu">float</span> <span class="op">=</span> <span class="fl">1.85</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    email: <span class="bu">str</span> <span class="op">=</span> <span class="st">&#39;joe@dataquest.io&#39;</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(Person(name<span class="op">=</span><span class="st">&#39;Tim&#39;</span>, age<span class="op">=</span><span class="dv">1000</span>))</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="op">==&gt;</span> Person(name<span class="op">=</span><span class="st">&#39;Tim&#39;</span>, age<span class="op">=</span><span class="dv">1000</span>, height<span class="op">=</span><span class="fl">1.85</span>, email<span class="op">=</span><span class="st">&#39;joe@dataquest.io&#39;</span>)</span></code></pre></div>
<h4 data-number="4.3.3" id="type-hints"><span
class="header-section-number">4.3.3</span> Type hints</h4>
<p>In other languages, types are taken very seriously and are the basis
for computation.</p>
<p>The Python type system was a bolt-on to later versions of the
language. Hence, it is not so well-defined.</p>
<p>But it is a great documentation tools since they let the programmer
tell the reader what goes in and out of their function.</p>
<p>Firstly, you can define your own types. For example,
<code>classes</code> stores rows of data about (e.g.) dogs and cats in a
dictionary whose keys are “dogs” and “cats”</p>
<div class="sourceCode" id="cb17"><pre
class="sourceCode py"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>data<span class="op">=</span> <span class="bu">dict</span>(dogs<span class="op">=</span>[[<span class="st">&#39;ralph&#39;</span>,<span class="st">&#39;poodle&#39;</span>,<span class="dv">2021</span>],[<span class="st">&#39;benhi&#39;</span>,<span class="st">&#39;labrador&#39;</span>,<span class="dv">2022</span>]]</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>           cats<span class="op">=</span>[[<span class="st">&#39;miss meow&#39;</span>, <span class="st">&#39;ginger&#39;</span> <span class="dv">2020</span>], etc])</span></code></pre></div>
<p>We can define these <code>classes</code> as follows:</p>
<div class="sourceCode" id="cb18"><pre
class="sourceCode py"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> __future__ <span class="im">import</span> annotations</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Any <span class="im">as</span> <span class="bu">any</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List, Dict, Type, Callable, Generator</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>number  <span class="op">=</span> <span class="bu">float</span>  <span class="op">|</span> <span class="bu">int</span>   <span class="co">#</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>atom    <span class="op">=</span> number <span class="op">|</span> <span class="bu">bool</span> <span class="op">|</span> <span class="bu">str</span> <span class="co"># and sometimes &quot;?&quot;</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>row     <span class="op">=</span> <span class="bu">list</span>[atom]</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>rows    <span class="op">=</span> <span class="bu">list</span>[row]</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>classes <span class="op">=</span> <span class="bu">dict</span>[<span class="bu">str</span>,rows] <span class="co"># `str` is the class name</span></span></code></pre></div>
<p>Then we can define a classifier as something that accepts
<code>classes</code> and a new row and returns a guess as to what class
it belongs to:</p>
<div class="sourceCode" id="cb19"><pre
class="sourceCode py"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> classifier(data: classes, example: row) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  ...</span></code></pre></div>
<p>Or, for a nearest neighbor classifier, we can define a function that
sorts all the rows by the distance to some new row called
<code>row1</code> as follows (and here, the nearest neighbor to
<code>row1</code> is the first item in the returned row.</p>
<div class="sourceCode" id="cb20"><pre
class="sourceCode py"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> neighbors(<span class="va">self</span>:DATA, row1:row, rows:rows<span class="op">=</span><span class="va">None</span>) <span class="op">-&gt;</span> rows:</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="bu">sorted</span>(rows, key<span class="op">=</span><span class="kw">lambda</span> row2: <span class="va">self</span>.dist(row1, row2))</span></code></pre></div>
<h4 data-number="4.3.4" id="abstraction"><span
class="header-section-number">4.3.4</span> Abstraction</h4>
<p>(Note that the following abstractions are available in many
languages. So are they a pattern? Or an idiom? I place them here since
the examples are Python-specific.)</p>
<h5 data-number="4.3.4.1" id="exception-handling"><span
class="header-section-number">4.3.4.1</span> Exception Handling</h5>
<p>XXX</p>
<h5 data-number="4.3.4.2" id="iterators"><span
class="header-section-number">4.3.4.2</span> Iterators</h5>
<p>Iterators are things that do some set up, yield one thing, then wait
till asked, then yield one other hing, then wait till asked, then yield
another other thing, etc. They are offer a simle interface to some
under-lying complex process.</p>
<p>For example, my code’s <code>csv</code> function opens a file,
removes spaces from each line, skips empty lines, splits lines on a
comma, then coerces each item in the row to some Python type. Note that
this function does not <code>return</code>, but it
<code>yields</code>.</p>
<div class="sourceCode" id="cb21"><pre
class="sourceCode py"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> csv(<span class="bu">file</span>) <span class="op">-&gt;</span> Generator[row]:</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  infile <span class="op">=</span> sys.stdin <span class="cf">if</span> <span class="bu">file</span><span class="op">==</span><span class="st">&quot;-&quot;</span> <span class="cf">else</span> <span class="bu">open</span>(<span class="bu">file</span>)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">with</span> infile <span class="im">as</span> src:</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> line <span class="kw">in</span> src:</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>      line <span class="op">=</span> re.sub(<span class="vs">r&#39;([\n\t\r ]|#.*)&#39;</span>, <span class="st">&#39;&#39;</span>, line)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> line: <span class="cf">yield</span> [<span class="bu">coerce</span>(s.strip()) <span class="cf">for</span> s <span class="kw">in</span> line.split(<span class="st">&quot;,&quot;</span>)]</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="bu">coerce</span>(s:<span class="bu">str</span>) <span class="op">-&gt;</span> atom:</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span>: <span class="cf">return</span> ast.literal_eval(s)</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">except</span> <span class="pp">Exception</span>:  <span class="cf">return</span> s</span></code></pre></div>
<p>We can call it this way (note the simplicity of the interface)</p>
<div class="sourceCode" id="cb22"><pre
class="sourceCode py"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> row <span class="kw">in</span> csv(fileName): </span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>   <span class="co"># row is now something like [4,86,65,80,3,2110,17.9,50]</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>   doSomethhing(fileName)</span></code></pre></div>
<p>Here’s another that implements a cross validation test rig where
learners train on some data, then test on some hold-out.</p>
<ol type="1">
<li>To avoid learn things due to trivial orderings in the file, we
shuffle the whole list</li>
<li>The shuffled list is then split into <code>n</code> bins.</li>
<li>For each bin, yield it as the <code>test</code> and all the other
bins as <code>rest</code>.</li>
<li>Optionally, only use some random sample of train, train</li>
</ol>
<p>The following is an m-by-n cross val. That is, from <code>m</code>
shuffling, yield <code>n</code> train,test set pairs. For the default
values (<code>m=n=5</code>) this yields 25 train,test set pairs.</p>
<div class="sourceCode" id="cb23"><pre
class="sourceCode py"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> xval(lst:<span class="bu">list</span>, m:<span class="bu">int</span><span class="op">=</span><span class="dv">5</span>, n:<span class="bu">int</span><span class="op">=</span><span class="dv">5</span>, some:<span class="bu">int</span><span class="op">=</span><span class="dv">10</span><span class="op">**</span><span class="dv">6</span>) <span class="op">-&gt;</span> Generator[rows,rows]:</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(m):</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    random.shuffle(lst)        <span class="co"># -------------------------------- [1]</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> n1 <span class="kw">in</span> <span class="bu">range</span> (n):</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>      lo <span class="op">=</span> <span class="bu">len</span>(lst)<span class="op">/</span>n <span class="op">*</span> n1      <span class="co"># ------------------------------- [2]  </span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>      hi <span class="op">=</span> <span class="bu">len</span>(lst)<span class="op">/</span>n <span class="op">*</span> (n1<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>      train, test <span class="op">=</span> [],[]</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> i,x <span class="kw">in</span> <span class="bu">enumerate</span>(lst):</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>        (test <span class="cf">if</span> i <span class="op">&gt;=</span> lo <span class="kw">and</span> i <span class="op">&lt;</span> hi <span class="cf">else</span> train).append(x) </span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>      train <span class="op">=</span> random.choices(train, k<span class="op">=</span><span class="bu">min</span>(<span class="bu">len</span>(train),some)) <span class="co"># --- [4]</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>      <span class="cf">yield</span> train,test  <span class="co">#---------------------------------------- [3]</span></span></code></pre></div>
<h4 data-number="4.3.5" id="comprehensions"><span
class="header-section-number">4.3.5</span> Comprehensions</h4>
<p>This code makes extensive use of comprehensions . E.g. to find the
middle of a cluster, ask each column for its middle point.</p>
<div class="sourceCode" id="cb24"><pre
class="sourceCode py"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="at">@of</span>(<span class="st">&quot;Return central tendency of a DATA.&quot;</span>)</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mid(<span class="va">self</span>:DATA) <span class="op">-&gt;</span> row:</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> [col.mid() <span class="cf">for</span> col <span class="kw">in</span> <span class="va">self</span>.cols.<span class="bu">all</span>]</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="at">@of</span>(<span class="st">&quot;Return central tendency of NUMs.&quot;</span>)</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mid(<span class="va">self</span>:NUM) <span class="op">-&gt;</span> number: <span class="cf">return</span> <span class="va">self</span>.mu</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="at">@of</span>(<span class="st">&quot;Return central tendency of SYMs.&quot;</span>)</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mid(<span class="va">self</span>:SYM) <span class="op">-&gt;</span> number: <span class="cf">return</span> <span class="va">self</span>.mode</span></code></pre></div>
<p>Comprehensions can be to filter data:</p>
<div class="sourceCode" id="cb25"><pre
class="sourceCode py"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> [i <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">10</span>) <span class="cf">if</span> i <span class="op">%</span> <span class="dv">2</span> <span class="op">==</span> <span class="dv">0</span>]</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>[<span class="dv">0</span>, <span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">6</span>, <span class="dv">8</span>]</span></code></pre></div>
<p>Here’s one for loading tab-separated files with optional comment
lines starting with a hash mark:</p>
<pre><code>data = [line.strip().split(&quot;\t&quot;) for line in open(&quot;my_file.tab&quot;) \
        if not line.startswith(&#39;#&#39;)]</code></pre>
<p>e.g. here are two examples of an implicit iterator in the argument to
<code>sum</code>:</p>
<div class="sourceCode" id="cb27"><pre
class="sourceCode py"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="at">@of</span>(<span class="st">&quot;Entropy = measure of disorder.&quot;</span>)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ent(<span class="va">self</span>:SYM) <span class="op">-&gt;</span> number:</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="op">-</span> <span class="bu">sum</span>(n<span class="op">/</span><span class="va">self</span>.n <span class="op">*</span> log(n<span class="op">/</span><span class="va">self</span>.n,<span class="dv">2</span>) <span class="cf">for</span> n <span class="kw">in</span> <span class="va">self</span>.has.values())</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="at">@of</span>(<span class="st">&quot;Euclidean distance between two rows.&quot;</span>)</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> dist(<span class="va">self</span>:DATA, r1:row, r2:row) <span class="op">-&gt;</span> <span class="bu">float</span>:</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>  n <span class="op">=</span> <span class="bu">sum</span>(c.dist(r1[c.at], r2[c.at])<span class="op">**</span>the.p <span class="cf">for</span> c <span class="kw">in</span> <span class="va">self</span>.cols.x)</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> (n <span class="op">/</span> <span class="bu">len</span>(<span class="va">self</span>.cols.x))<span class="op">**</span>(<span class="dv">1</span><span class="op">/</span>the.p)</span></code></pre></div>
<p>E.g here we</p>
<ol type="1">
<li>Use dictionary comprehensions, make a dictionary with one emery list
per key,</li>
<li>Using list comprehensions, add items into those lists</li>
<li>Finally, using dictionary comprehensions, return a dictionary with
one prediction per col.</li>
</ol>
<div class="sourceCode" id="cb28"><pre
class="sourceCode py"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="at">@of</span>(<span class="st">&quot;Return predictions for `cols` (defaults to klass column).&quot;</span>)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> predict(<span class="va">self</span>:DATA, row1:row, rows:rows, cols<span class="op">=</span><span class="va">None</span>, k<span class="op">=</span><span class="dv">2</span>):</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  cols <span class="op">=</span> cols <span class="kw">or</span> <span class="va">self</span>.cols.y</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  got <span class="op">=</span> {col.at : [] <span class="cf">for</span> col <span class="kw">in</span> cols}                           <span class="op">--</span> [<span class="dv">1</span>]</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> row2 <span class="kw">in</span> <span class="va">self</span>.neighbors(row1, rows)[:k]:</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    d <span class="op">=</span>  <span class="fl">1E-32</span> <span class="op">+</span> <span class="va">self</span>.dist(row1,row2)</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    [got[col.at].append( (d, row2[col.at]) )  <span class="cf">for</span> col <span class="kw">in</span> cols]  <span class="op">--</span> [<span class="dv">2</span>]</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> {col.at : col.predict( got[col.at] ) <span class="cf">for</span> col <span class="kw">in</span> cols}  <span class="op">--</span> [<span class="dv">3</span>]</span></code></pre></div>
<h4 data-number="4.3.6" id="decorators"><span
class="header-section-number">4.3.6</span> Decorators</h4>
<ul>
<li>Decorated are functions called at load time that manipulate other
functions.</li>
<li>E.g. the <code>of</code> decorator lets you define methods outside
of a function. Here it is used to group together the <code>mid</code>
(middle) and <code>div</code> (diversity) functions.
<ul>
<li>The <code>mid</code>(ddle) of a NUMeric and a SYMbol column are
their means and modes.</li>
<li>As to <code>DATA</code>, thsee hold rows which are summarized in
<code>cols</code>. The <code>mid</code> of those rows is the
<code>mid</code> of the summary for each column.</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb29"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> of(doc):</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> doit(fun):</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>    fun.__doc__ <span class="op">=</span> doc</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span> <span class="op">=</span> inspect.getfullargspec(fun).annotations[<span class="st">&#39;self&#39;</span>]</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">setattr</span>(<span class="bu">globals</span>()[<span class="va">self</span>], fun.<span class="va">__name__</span>, fun)</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> doit</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a><span class="at">@of</span>(<span class="st">&quot;Return central tendency of a DATA.&quot;</span>)</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mid(<span class="va">self</span>:DATA) <span class="op">-&gt;</span> row:</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> [col.mid() <span class="cf">for</span> col <span class="kw">in</span> <span class="va">self</span>.cols.<span class="bu">all</span>]</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a><span class="at">@of</span>(<span class="st">&quot;Return central tendency of NUMs.&quot;</span>)</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mid(<span class="va">self</span>:NUM) <span class="op">-&gt;</span> number: <span class="cf">return</span> <span class="va">self</span>.mu</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a><span class="at">@of</span>(<span class="st">&quot;Return central tendency of SYMs.&quot;</span>)</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mid(<span class="va">self</span>:SYM) <span class="op">-&gt;</span> number: <span class="cf">return</span> <span class="va">self</span>.mode</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a><span class="at">@of</span>(<span class="st">&quot;Return diversity of a NUM.&quot;</span>)</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> div(<span class="va">self</span>:NUM) <span class="op">-&gt;</span> number: <span class="cf">return</span> <span class="va">self</span>.sd</span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a><span class="at">@of</span>(<span class="st">&quot;Return diversity of a SYM.&quot;</span>)</span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> div(<span class="va">self</span>:SYM) <span class="op">-&gt;</span> number: <span class="cf">return</span> <span class="va">self</span>.ent()</span></code></pre></div>
<h2 data-number="5" id="try-it-for-yourself"><span
class="header-section-number">5</span> Try it for yourself</h2>
<h3 data-number="5.1" id="get-python3.13"><span
class="header-section-number">5.1</span> Get Python3.13</h3>
<p>Make sure you are running Python3.13. On Linux and Github code
spaces, that command is</p>
<div class="sourceCode" id="cb30"><pre
class="sourceCode sh"><code class="sourceCode bash"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt update</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span>  apt upgrade</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt install software-properties-common <span class="at">-y</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> add-apt-repository ppa:deadsnakes/ppa</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt update</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt install python3.13</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="ex">python3.13</span> <span class="at">-B</span> <span class="at">--verion</span></span></code></pre></div>
<h3 data-number="5.2" id="try-one-run"><span
class="header-section-number">5.2</span> Try one run</h3>
<div class="sourceCode" id="cb31"><pre
class="sourceCode sh"><code class="sourceCode bash"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/timm/moot</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> clone https://github.com/timm/ezr</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> ezr</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="ex">python3.13</span> <span class="at">-B</span> erz.py <span class="at">-t</span> ../moot/optimize/misc/auto93.csv <span class="at">-e</span> _mqs</span></code></pre></div>
<h3 data-number="5.3" id="try-a-longer-run"><span
class="header-section-number">5.3</span> Try a longer run</h3>
<p>Do a large run (takes a few minutes: output will appear in
~/tmp/mqs.out; assumes a BASH shell):</p>
<div class="sourceCode" id="cb32"><pre
class="sourceCode sh"><code class="sourceCode bash"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="ex">python3.13</span> <span class="at">-B</span> ezr.py <span class="at">-e</span> _MQS ../moot/optimize/<span class="pp">[</span><span class="ss">chmp</span><span class="pp">]*</span>/<span class="pp">*</span>.csv <span class="kw">|</span> <span class="fu">tee</span> ~/tmp/mqs.out</span></code></pre></div>
<h3 data-number="5.4" id="write-your-own-extensions"><span
class="header-section-number">5.4</span> Write your own extensions</h3>
<p>Here’s a file <code>extend.py</code> in the same directory as
ezr.py</p>
<div class="sourceCode" id="cb33"><pre
class="sourceCode py"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys,random</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ezr <span class="im">import</span> the, DATA, csv, dot</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> show(lst):</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="bu">print</span>(<span class="op">*</span>[<span class="ss">f&quot;</span><span class="sc">{</span>word<span class="sc">:6}</span><span class="ss">&quot;</span> <span class="cf">for</span> word <span class="kw">in</span> lst], sep<span class="op">=</span><span class="st">&quot;</span><span class="ch">\t</span><span class="st">&quot;</span>)</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> myfun(train):</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>  d    <span class="op">=</span> DATA().adds(csv(train))</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>  x    <span class="op">=</span> <span class="bu">len</span>(d.cols.x)</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>  size <span class="op">=</span> <span class="bu">len</span>(d.rows)</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>  dim  <span class="op">=</span> <span class="st">&quot;small&quot;</span> <span class="cf">if</span> x <span class="op">&lt;=</span> <span class="dv">5</span> <span class="cf">else</span> (<span class="st">&quot;med&quot;</span> <span class="cf">if</span> x <span class="op">&lt;</span> <span class="dv">12</span> <span class="cf">else</span> <span class="st">&quot;hi&quot;</span>)</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>  size <span class="op">=</span> <span class="st">&quot;small&quot;</span> <span class="cf">if</span> size<span class="op">&lt;</span> <span class="dv">500</span> <span class="cf">else</span> (<span class="st">&quot;med&quot;</span> <span class="cf">if</span> size<span class="op">&lt;</span><span class="dv">5000</span> <span class="cf">else</span> <span class="st">&quot;hi&quot;</span>)</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> [dim, size, x,<span class="bu">len</span>(d.cols.y), <span class="bu">len</span>(d.rows), train[<span class="dv">17</span>:]]</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>random.seed(the.seed) <span class="co">#  not needed here, but good practice to always take care of seeds</span></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>show([<span class="st">&quot;dim&quot;</span>, <span class="st">&quot;size&quot;</span>,<span class="st">&quot;xcols&quot;</span>,<span class="st">&quot;ycols&quot;</span>,<span class="st">&quot;rows&quot;</span>,<span class="st">&quot;file&quot;</span>])</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>show([<span class="st">&quot;------&quot;</span>] <span class="op">*</span> <span class="dv">6</span>)</span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>[show(myfun(arg)) <span class="cf">for</span> arg <span class="kw">in</span> sys.argv <span class="cf">if</span> arg[<span class="op">-</span><span class="dv">4</span>:] <span class="op">==</span> <span class="st">&quot;.csv&quot;</span>]</span></code></pre></div>
<p>On my machine, when I run</p>
<div class="sourceCode" id="cb34"><pre
class="sourceCode py"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>python3<span class="fl">.13</span> <span class="op">-</span>B extend.py ..<span class="op">/</span>moot<span class="op">/</span>optimize<span class="op">/</span>[chmp]<span class="op">*/*</span>.csv</span></code></pre></div>
<p>This prints some stats on the data files:</p>
<pre><code>dim     size    xcols   ycols   rows    file
------  ------  ------  ------  ------  ------
small   small        4       3     398  misc/auto93.csv
small   small        4       2     259  config/SS-H.csv
small   small        3       2     206  config/SS-B.csv
small   small        3       2     196  config/SS-G.csv
small   small        3       2     196  config/SS-F.csv
small   small        3       2     196  config/SS-D.csv
small   small        3       1     196  config/wc+wc-3d-c4-obj1.csv
small   small        3       1     196  config/wc+sol-3d-c4-obj1.csv
small   small        3       1     196  config/wc+rs-3d-c4-obj1.csv
small   med          5       2    1080  config/SS-I.csv
small   med          3       2    1512  config/SS-C.csv
small   med          3       2    1343  config/SS-A.csv
small   med          3       2     756  config/SS-E.csv
small   hi           5       3   10000  hpo/healthCloseIsses12mths0011-easy.csv
small   hi           5       3   10000  hpo/healthCloseIsses12mths0001-hard.csv
med     small        9       1     192  config/Apache_AllMeasurements.csv
med     med         11       2    1023  config/SS-P.csv
med     med         11       2    1023  config/SS-L.csv
med     med         11       2     972  config/SS-O.csv
med     med         10       2    1599  misc/Wine_quality.csv
med     med          9       3     500  process/pom3d.csv
med     med          6       2    3840  config/SS-S.csv
med     med          6       2    3840  config/SS-J.csv
med     med          6       2    2880  config/SS-K.csv
med     med          6       1    3840  config/rs-6d-c3_obj2.csv
med     med          6       1    3840  config/rs-6d-c3_obj1.csv
med     med          6       1    2880  config/wc-6d-c1-obj1.csv
med     med          6       1    2866  config/sol-6d-c2-obj1.csv
med     hi          11       2   86058  config/SS-X.csv
med     hi           9       3   20000  process/pom3c.csv
med     hi           9       3   20000  process/pom3b.csv
med     hi           9       3   20000  process/pom3a.csv
hi      small       22       4      93  process/nasa93dem.csv
hi      med         38       1    4653  config/SQL_AllMeasurements.csv
hi      med         21       2    4608  config/SS-U.csv
hi      med         17       5    1000  process/coc1000.csv
hi      med         17       3     864  config/SS-M.csv
hi      med         16       1    1152  config/X264_AllMeasurements.csv
hi      med         14       2    3008  config/SS-R.csv
hi      med         14       1    3456  config/HSMGP_num.csv
hi      med         13       3    2736  config/SS-Q.csv
hi      hi          23       4   10000  process/xomo_osp2.csv
hi      hi          23       4   10000  process/xomo_osp.csv
hi      hi          23       4   10000  process/xomo_ground.csv
hi      hi          23       4   10000  process/xomo_flight.csv
hi      hi          17       2   53662  config/SS-N.csv
hi      hi          16       2   65536  config/SS-W.csv
hi      hi          16       2    6840  config/SS-V.csv
hi      hi          12       2    5184  config/SS-T.csv</code></pre>
<p>Try modifying the output to add columns to report counts of the
number of symbolic and numeric columns.</p>
<section id="footnotes" class="footnotes footnotes-end-of-document"
role="doc-endnotes">
<hr />
<ol>
<li id="fn1"><p>Q. Zhang and H. Li, “MOEA/D: A Multiobjective
Evolutionary Algorithm Based on Decomposition,” in IEEE Transactions on
Evolutionary Computation, vol. 11, no. 6, pp. 712-731, Dec. 2007, doi:
10.1109/TEVC.2007.892759.<a href="#fnref1" class="footnote-back"
role="doc-backlink">↩︎</a></p></li>
<li id="fn2"><p><a
href="https://www.researchgate.net/publication/299868537_Hey_you_have_given_me_too_many_knobs_understanding_and_dealing_with_over-designed_configuration_in_system_software">Hey
you have given me too many knobs</a>, FSE’15<a href="#fnref2"
class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>
</body>
</html>
